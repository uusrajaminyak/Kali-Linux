import os
import pefile
from qiling import *
from qiling.const import QL_VERBOSE
from qiling.os.windows import registry
from qiling.loader.pe import QlLoaderPE

def bypass_registry_init(self, ql, reghive):
    return
registry.RegistryManager.__init__ = bypass_registry_init
original_init_imports = QlLoaderPE.init_imports

def patched_init_imports(self, pe, is_driver):
    if not hasattr(pe, 'DIRECTORY_ENTRY_IMPORT'):
        pe.DIRECTORY_ENTRY_IMPORT = []
    return original_init_imports(self, pe, is_driver)
QlLoaderPE.init_imports = patched_init_imports

TARGET_FILE = "packed_malware.exe" 
ROOTFS = os.path.join(os.path.dirname(os.path.abspath(__file__)), "rootfs", "x8664_windows")


def get_region(file_path):
    pe = pefile.PE(file_path)
    target_section = pe.sections[0]
    image_base = pe.OPTIONAL_HEADER.ImageBase
    start_address = image_base + target_section.VirtualAddress
    end_address = start_address + target_section.Misc_VirtualSize

    print(f"[+] Target Area detected: 0x{start_address:x} - 0x{end_address:x}")
    print(f"[+] Section Name: {target_section.Name.decode().rstrip(chr(0))}")
    return (start_address, end_address)

def check_oep(ql, address, size):
    current_rip = ql.arch.regs.read("RIP")
    if oep_start <= current_rip < oep_end:
        print(f"\n[!] OEP Reached at: 0x{current_rip:x}")
        print("[*] Dumping unpacked binary...")
        try:
            dump_size = oep_end - oep_start
            unpacked_data = ql.mem.read(oep_start, dump_size)
            output_file = "unpacked_payload.bin"
            with open(output_file, "wb") as f:
                f.write(unpacked_data)
            print(f"[+] Unpacked binary saved to {output_file}")
            print(f"[+] Dumped Size: {dump_size} bytes")
        except Exception as e:
            print(f"[!] Error during dumping: {e}")
        ql.stop()

if __name__ == "__main__":
    print("[*] Starting Malware Unpacker...")
    oep_start, oep_end = get_region(TARGET_FILE)
    print("[*] Initializing Qiling Emulation Environment...")
    ql = Qiling([TARGET_FILE], rootfs=ROOTFS, verbose=QL_VERBOSE.OFF, console=False)
    ql.hook_code(check_oep)
    try:
        ql.run()
    except Exception as e:
        print(f"[!] Emulation stopped: {e}")
    print("[*] Unpacking completed.")
