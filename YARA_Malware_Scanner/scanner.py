import yara
import os
import time
import shutil
import sys

Rules_File = 'rules.yar'
Scan_Dir = '.'
quarantine_dir = './quarantine'

def scan_file():
    print("[*] Loading YARA rules from {Rules_File}...", end=" ")
    try:
        rules = yara.compile(Rules_File)
        print("Done.")
    except yara.Error as e:
        print(f"Failed to compile YARA rules: {e}")
        sys.exit(1)

    print(f"Starting scan in: {os.path.abspath(Scan_Dir)}")
    time.sleep(1)

    infected = 0
    for root, dirs, files in os.walk(Scan_Dir):
        for file in files:
            if file in ['scanner.py', 'rules.yar'] or 'quarantine' in root:
                continue
            file_path = os.path.join(root, file)
            try:
                matches = rules.match(file_path)
                if matches:
                    infected += 1
                    print(f"[!] Malware found: {file_path}")
                    if not os.path.exists(quarantine_dir):
                        os.makedirs(quarantine_dir)
                    new_path = os.path.join(quarantine_dir, file + '.infected')
                    shutil.move(file_path, new_path)
            except yara.Error as e:
                print(f"Error scanning file {file_path}: {e}")

    if infected == 0:
        print("[*] No malware found.")
    else:
        print(f"[*] Scan complete. {infected} infected files moved to quarantine.")

if __name__ == "__main__":
    scan_file()